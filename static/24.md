---
Id: 24
Title: Kubectlå‘½ä»¤è¡Œ
Date: é™†æœˆè´°
Year: 2021
Summary: Kubernetes å‘½ä»¤è¡Œé€Ÿè®°
Tags:
  - Kubernetes
---

*æ³¨ï¼šåŸºäºKubenetes ç‰ˆæœ¬ï¼šServer v1.17.2ã€Client v1.17.9*

## kubectlå‘½ä»¤è¡Œå…¨æ™¯å›¾

[kubectlğŸ”—](https://hindung.oss-cn-beijing.aliyuncs.com/img/kubectl.png)

## æœ‰è¶£çš„kubectlå‘½ä»¤

### è·å–æ­£åœ¨Runningçš„Pod

```bash
kubectl get pods -A --field-selector=status.phase==Running
NAMESPACE     NAME                                     READY   STATUS    RESTARTS   AGE
kelu          cka2-75dbf7c54-gm4r4                     1/1     Running   0          23h
kube-system   calico-kube-controllers-ccf66db4-cpvqp   1/1     Running   0          3d20h
kube-system   calico-node-8d4th                        1/1     Running   0          3d2h
kube-system   calico-node-szmzb                        1/1     Running   0          3d20h
```

### æŸ¥çœ‹èŠ‚ç‚¹å†…å­˜å®¹é‡

```bash
kubectl get no -o json |    jq -r '.items | sort_by(.status.capacity.memory)[]|[.metadata.name,.status.capacity.memory]| @tsv'
rq-bjptest01    3848040Ki
rqinterntest2   7986060Ki
```



### æŸ¥çœ‹å„ä¸ªèŠ‚ç‚¹ä¸Šçš„Podæ•°é‡

```bash
kubectl get po -o json --all-namespaces |  jq '.items | group_by(.spec.nodeName) | map({"nodeName": .[0].spec.nodeName, "count": length}) | sort_by(.count)'
[
  {
    "nodeName": "rq-bjptest01",
    "count": 3
  },
  {
    "nodeName": "rqinterntest2",
    "count": 8
  }
]
kubectl get pods --all-namespaces -o json | jq '.items[] | .spec.nodeName' -r | sort | uniq -c
     17 rqkubedev03
     30 rqkubedev04
     23 rqkubedev05
```



### æŸ¥çœ‹PODä»¥åŠé•œåƒ

```bash
kubectl get pods -o custom-columns='NAME:metadata.name,IMAGES:spec.containers[*].image'
NAME                              IMAGES
details-v1-5974b67c8-gqz94        docker.io/istio/examples-bookinfo-details-v1:1.16.2,docker.io/istio/proxyv2:1.7.2
gitea-5bb577b964-w64gg            harbor.caih.local/gitea/gitea:1.10.1
productpage-v1-64794f5db4-hw2fl   docker.io/istio/examples-bookinfo-productpage-v1:1.16.2,docker.io/istio/proxyv2:1.7.2
```

### æŸ¥çœ‹å„ä¸ªèŠ‚ç‚¹ä¸Šçš„POD

```bash
kubectl get pods --all-namespaces -o json | jq '.items | map({podName: .metadata.name, nodeName: .spec.nodeName}) | group_by(.nodeName) | map({nodeName: .[0].nodeName, pods: map(.podName)})'
[
  {
    "nodeName": "rqkubedev03",
    "pods": [
      "123-84654b5d8f-sm2dt",
      "reviews-v2-6cb6ccd848-ndsqq",
      "fleet-agent-6cc4bd5c67-b877w",
      "jaeger-es-index-cleaner-1602806100-5ngzz",
      "jaeger-es-index-cleaner-1602806100-b47gk",
      "jaeger-es-index-cleaner-1602806100-kkx2z",
      "jaeger-es-index-cleaner-1602806100-rg6z8",
      "jaeger-es-index-cleaner-1602806100-s47n4",
```



### æŸ¥çœ‹Podå ç”¨çš„å†…å­˜å’ŒCPUå¹¶æŒ‰å†…å­˜æˆ–è€…CPUæ’åº

```bash
# å†…å­˜
kubectl top pods -A | sort --reverse --key 4 --numeric
caihcloud              jenkinsm-6fc5d7fc46-2tl6q                            29m          1995Mi
istio-system           prometheus-788c945c9c-mdrjf                          97m          1424Mi
kube-system            kube-apiserver-rqkubedev04                           149m         957Mi
kube-system            kube-apiserver-rqkubedev03                           69m          476Mi
caihcloud              jenkinsslaveswarm-6c6f5d8d9b-8ns5w                   2m           464Mi

# CPU
kubectl top pods -A | sort --reverse --key 3 --numeric
kube-system            kube-apiserver-rqkubedev04                           150m         964Mi
istio-system           prometheus-788c945c9c-mdrjf                          89m          1426Mi
kube-system            kube-apiserver-rqkubedev03                           42m          532Mi
kube-system            calico-node-6n65m                                    42m          46Mi
kube-system            calico-node-fg6tk                                    34m          49Mi

```

### è·å–é‡å¯æ¬¡æ•°é™åºæ’åºçš„Pod

```bash
kubectl get pods -A --sort-by=.status.containerStatuses[0].restartCount | tac
kube-system            kube-scheduler-rqkubedev03                           0/1     CrashLoopBackOff   593        2d2h
traefik-v2             traefik-gfnw5                                        1/1     Running            27         23d
kube-system            kube-controller-manager-rqkubedev03                  1/1     Running            24         23d
kube-system            kube-controller-manager-rqkubedev04                  1/1     Running            22         23d
kube-system            kube-apiserver-rqkubedev03                           1/1     Running            21         23d
NAMESPACE              NAME                                                 READY   STATUS             RESTARTS   AGE
```

### è·å¾—æ‰€æœ‰PODçš„requestå’Œlimits

```bash
kubectl get pods -A  -o custom-columns='NAME:metadata.name,MEM_REQUEST:spec.containers[*].resources.requests.memory,MEM_LIMIT:spec.containers[*].resources.limits.memory,CPU_REQUEST:spec.containers[*].resources.requests.cpu,CPU_LIMIT:spec.containers[*].resources.limits.cpu'       
NAME                                                 MEM_REQUEST   MEM_LIMIT     CPU_REQUEST   CPU_LIMIT
123-84654b5d8f-sm2dt                                 <none>        <none>        <none>        <none>
backend-c56f64647-grql6                              10Mi          1Gi           10m           <none>
caihcloud-67ffdf9fc9-wzmts                           10Mi          1Gi           10m           <none>
caihcloud-ui-9fbb954dc-trtn7                         10Mi          1Gi           10m           <none>
caihcloudm-caihcloudm-api-5cfffcc96-mz6pt            10Mi          1Gi           10m           200m
caihcloudm-caihcloudm-api-5cfffcc96-xdwsb            10Mi          1Gi           10m           200m
```


### è·å–èŠ‚ç‚¹çš„IP

```bash
kubectl get nodes -o jsonpath='{range .items[*]}{.metadata.name} {.status.addresses[?(@.type=="InternalIP")].address}{"\n"}{end}'
rqkubedev03 10.19.0.57
rqkubedev04 10.19.0.58
rqkubedev05 10.19.0.59
```

### è·å–Serviceçš„Nodeportä¿¡æ¯

```bash
kubectl get -A svc -o json | jq -r '.items[] | [.metadata.name,([.spec.ports[].nodePort | tostring ] | join("|"))]| @tsv'
backend 23168|20675
caihcloud       37386
caihcloud-ui    26105
caihcloudm-caihcloudm-api       36236
caihcloudm-caihcloudm-prerender 31964
```

### è·å–PODç½‘æ®µ

```bash
kubectl get nodes -o jsonpath='{.items[*].spec.podCIDR}' | tr " " "\n"
10.193.0.0/24
10.193.1.0/24
10.193.2.0/24
```

### è¾“å‡ºä¸€ä¸ªPODä¸­æ‰€æœ‰çš„å®¹å™¨çš„æ—¥å¿—

```bash
kubectl logs caihcloudm-caihcloudm-api-5cfffcc96-mz6pt -n caihcloud â€”all-containers
```

### æŒ‰æ ‡ç­¾è¾“å‡ºPODçš„æ—¥å¿—

```bash
kubectl -n caihcloud logs -f -l app=caihcloudm-caihcloudm-api
```

### è·å–å‰ä¸€ä¸ªå®¹å™¨çš„æ—¥å¿—ï¼ˆå®¹å™¨å¼‚å¸¸æŒ‚æ‰çš„åœºæ™¯ï¼‰

```bash
kubectl logs caihcloud-67ffdf9fc9-wzmts -n caihcloud --previous
```